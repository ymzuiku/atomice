(function(r,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],a):(r=typeof globalThis<"u"?globalThis:r||self,a(r.oneway={},r.React))})(this,function(r,a){"use strict";const i=typeof window>"u";let d=!1;function l(e,f,o={}){const S=[],v=[],g=JSON.stringify({v:f});let m=!1;const t={value:f,events:new Set([]),setValue:()=>{},loadStorage:async()=>{},getDefaultValue:()=>JSON.parse(g).v,addAfter:n=>{v.push(n)},addBefore:n=>{S.push(n)},Render:({children:n})=>n(f)};return o.after&&t.addAfter(o.after),o.before&&t.addBefore(o.before),t.Render=c(({children:n})=>(R(t),n?n(t.value):t.value)),t.setValue=async n=>{if(typeof n=="function"&&(n=n(t.value)),n!==t.value){t.value=n;for(const s of S)await Promise.resolve(s());if(setTimeout(()=>{t.events.forEach(s=>{s(t.value)})}),!i&&e)if(o.saveStorage)o.saveStorage(t.value);else{const s=o.storage==="sessionStorage"?sessionStorage:localStorage,u=JSON.stringify({v:t.value});t.value===""||t.value===null||t.value===void 0||u===g?s.removeItem(e):s.setItem(e,u)}for(const s of v)s()}},e&&(t.loadStorage=()=>{if(!(!e||i||m))if(d=!0,m=!0,o.loadStorage)o.loadStorage(e).then(n=>{t.setValue(n)});else{const s=(o.storage==="sessionStorage"?sessionStorage:localStorage).getItem(e);if(typeof s=="string")try{const u=JSON.parse(s).v;t.setValue(u)}catch{}}},d&&t.loadStorage()),t}function h(e,f){return l("",e,f)}const B=[];function R(e){const[f,o]=a.useState(e.value);return a.useMemo(()=>{e.events.add(o)},[]),a.useEffect(()=>(e.events.add(o),e.loadStorage(),()=>{e.events.delete(o)}),B),[f,e.setValue]}function y(e){const f=()=>{if(!i){if(!d){setTimeout(f);return}e()}};f()}function T({children:e}){return a.useRef(e).current}function c(e){return a.memo(e,()=>!1)}function w(e){return a.useMemo(e,[])}r.Block=T,r.atom=h,r.atomWithStorage=l,r.onStorageLoaded=y,r.staticComponent=c,r.useBlock=w,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
