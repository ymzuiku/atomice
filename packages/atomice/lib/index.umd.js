(function(r,f){typeof exports=="object"&&typeof module<"u"?f(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],f):(r=typeof globalThis<"u"?globalThis:r||self,f(r.atomice={},r.React))})(this,function(r,f){"use strict";const d=typeof window>"u";let i=!1;function l(e,s,o={}){const v=[],g=[],m=JSON.stringify({v:s});let h=!1;const t={value:s,events:new Set([]),setValue:()=>{},loadStorage:async()=>{},getDefaultValue:()=>JSON.parse(m).v,addAfter:n=>{g.push(n)},addBefore:n=>{v.push(n)},Render:({children:n})=>n(s)};return o.after&&t.addAfter(o.after),o.before&&t.addBefore(o.before),t.Render=S(({children:n})=>(c(t),n?n(t.value):t.value)),t.setValue=async n=>{if(typeof n=="function"&&(n=n(t.value)),n!==t.value){t.value=n;for(const a of v)await Promise.resolve(a());if(setTimeout(()=>{t.events.forEach(a=>{a(t.value)})}),!d&&e)if(o.saveStorage)o.saveStorage(t.value);else{const a=o.storage==="sessionStorage"?sessionStorage:localStorage,u=JSON.stringify({v:t.value});t.value===""||t.value===null||t.value===void 0||u===m?a.removeItem(e):a.setItem(e,u)}for(const a of g)a()}},e&&(t.loadStorage=()=>{if(!(!e||d||h))if(i=!0,h=!0,o.loadStorage)o.loadStorage(e).then(n=>{t.setValue(n)});else{const a=(o.storage==="sessionStorage"?sessionStorage:localStorage).getItem(e);if(typeof a=="string")try{const u=JSON.parse(a).v;t.setValue(u)}catch{}}},e&&(i?t.loadStorage():setTimeout(()=>{t.loadStorage()},500))),t}function R(e,s){return l("",e,s)}const T=[];function c(e){const[s,o]=f.useState(e.value);return f.useMemo(()=>{e.events.add(o)},[]),f.useEffect(()=>(e.events.add(o),e.loadStorage(),()=>{e.events.delete(o)}),T),[s,e.setValue]}function y(e){const s=()=>{if(!d){if(!i){setTimeout(s);return}e()}};s()}function A({children:e}){return f.useRef(e).current}function S(e){return f.memo(e,()=>!1)}function B(e){const s=()=>{i?e():setTimeout(s,50)};s()}r.Block=A,r.atom=R,r.atomWithStorage=l,r.onMount=B,r.onStorageLoaded=y,r.staticComponent=S,r.useRerender=c,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
